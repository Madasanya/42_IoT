Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/jammy64"  # Ubuntu 22.04
#  config.vm.box.url =
  # Shared folder visible to ALL VMs
  config.vm.synced_folder "./shared", "/vagrant_shared"
  config.trigger.before :up do |t|
    t.info = "Preparing folders"
    t.run = {inline: "mkdir -p ./shared"}
  end
  config.trigger.after :destroy do |t|
    t.info = "Cleaning keys"
    t.run = {inline: "rm ./shared/worker_id_rsa.pub"}
  end 

  # Common provisioning for SSH setup (passwordless between VMs)
  config.vm.provision "shell", inline: <<-SHELL
    sudo apt update -y
    sudo apt install -y openssh-server net-tools
    sudo systemctl enable ssh
    sudo systemctl start ssh
    sudo sed -i 's/#PermitRootLogin.*/PermitRootLogin without-password/' /etc/ssh/sshd_config
    sudo systemctl restart ssh
  SHELL

  config.vm.define "dbanfiSW" do |worker|
    worker.vm.hostname = "dbanfiSW"
    worker.vm.network "private_network", ip: "192.168.56.111"
    worker.vm.provider "virtualbox" do |vb|
      vb.customize ["modifyvm", :id, "--name", "dbanfiSW"]
      vb.memory = "1024"
      vb.cpus = 1
    end
    worker.vm.provision "shell", path: "./scripts/worker_up.sh"
   # worker.trigger.after :up do |t|
   #   t.info = "Starting worker setup..."
   #   t.run_remote = { inline: "bash /vagrant/scripts/worker_setup.sh" }
   # end
  end

  config.vm.define "dbanfiS" do |server|
    server.vm.hostname = "dbanfiS"
    server.vm.network "private_network", ip: "192.168.56.110"
    server.vm.provider "virtualbox" do |vb|
      vb.customize ["modifyvm", :id, "--name", "dbanfiS"]
      vb.memory = "1024"
      vb.cpus = 1
    end
    server.vm.provision "shell", path: "./scripts/server_up.sh"
    server.trigger.after :up do |t|
      t.info = "Starting server setup..."
      t.run = { inline: "vagrant ssh dbanfiSW -c 'sudo -i -u k3s-admin  bash /vagrant/scripts/worker_setup.sh'" }
    end
  end
end
